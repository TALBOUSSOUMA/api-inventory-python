name: CI-CD Inventory API

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches:
      - main
      - develop

jobs:
  # =========================
  # Job 1 : Tests & Qualité
  # =========================
  tests:
    name: tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          flake8 app/ --count --max-line-length=100 --statistics

      - name: Run tests with pytest
        run: |
          pytest tests/ -v

  # =========================
  # Job 2 : Build & Sécurité
  # =========================
  security:
    name: security
    runs-on: ubuntu-latest
    needs: [tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t inventory-api:test .

      - name: Check image size < 100MB
        run: |
          IMAGE_SIZE=$(docker image inspect inventory-api:test --format='{{.Size}}')
          MAX_SIZE=$((100*1024*1024))
          echo "Image size: $IMAGE_SIZE bytes"
          if [ "$IMAGE_SIZE" -ge "$MAX_SIZE" ]; then
            echo "Image is larger than 100MB"
            exit 1
          fi

      - name: Security scan with Trivy (non-blocking)
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "inventory-api:test"
          format: "table"
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

  # =========================
  # Job 3 : Auto PR develop -> main
  # =========================
  auto-merge-to-main:
    name: auto-merge-to-main
    runs-on: ubuntu-latest
    needs: [tests, security]
    if: github.ref == 'refs/heads/develop'
    continue-on-error: true # <-- ajoute cette ligne

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Pull Request from develop to main
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "develop"
          destination_branch: "main"
          pr_title: "Release: Develop to Main"
          pr_body: "Automated PR from develop to main (CI-CD pipeline)."
          github_token: "${{ secrets.GITHUB_TOKEN }}"

  # =========================
  # Job 4 : Déploiement PRODUCTION
  # (optionnel, pour main uniquement)
  # =========================
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: [tests, security]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deployment info
        run: |
          echo "Deploying Inventory API"
          echo "Commit SHA: $GITHUB_SHA"
          echo "Environment: PRODUCTION"
          echo "Date/Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
